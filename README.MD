# üåè Administrative Boundaries API

**API h·ªá th·ªëng ranh gi·ªõi h√†nh ch√≠nh Vi·ªát Nam** - Cung c·∫•p d·ªØ li·ªáu t·ªânh/th√†nh ph·ªë, qu·∫≠n/huy·ªán, ph∆∞·ªùng/x√£ v·ªõi kh·∫£ nƒÉng CRUD v√† ƒë·ªìng b·ªô t·ª± ƒë·ªông.

## üìã T·ªïng quan d·ª± √°n

D·ª± √°n n√†y x√¢y d·ª±ng m·ªôt **API RESTful** ƒë·ªÉ qu·∫£n l√Ω d·ªØ li·ªáu h√†nh ch√≠nh Vi·ªát Nam, bao g·ªìm:
- **63 t·ªânh/th√†nh ph·ªë**
- **H√†ng ngh√¨n qu·∫≠n/huy·ªán** 
- **H√†ng ch·ª•c ngh√¨n ph∆∞·ªùng/x√£**

V·ªõi kh·∫£ nƒÉng t√¨m ki·∫øm, chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ, qu·∫£n l√Ω l·ªãch s·ª≠ v√† ƒë·ªìng b·ªô t·ª± ƒë·ªông.

### üéØ T√≠nh nƒÉng ch√≠nh
- **Dual Storage System**: MongoDB + JSON fallback ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh s·∫µn s√†ng cao
- **CRUD Operations**: T·∫°o, ƒë·ªçc, c·∫≠p nh·∫≠t, x√≥a ƒë∆°n v·ªã h√†nh ch√≠nh v·ªõi l·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß
- **Auto Sync**: T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu h√†ng ng√†y t·ª´ API b√™n ngo√†i
- **Address Conversion**: Chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ t·ª± nhi√™n th√†nh m√£ h√†nh ch√≠nh
- **Comprehensive Testing**: 100% test coverage v·ªõi Jest
- **Performance Optimized**: Indexing, caching, bulk operations

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   External API  ‚îÇ    ‚îÇ   Express API   ‚îÇ    ‚îÇ    MongoDB      ‚îÇ
‚îÇ  (address-kit)  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Server       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Database      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ   JSON Backup   ‚îÇ
                       ‚îÇ  (fallback)     ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Lu·ªìng ho·∫°t ƒë·ªông ch√≠nh

### **1. Kh·ªüi ƒë·ªông h·ªá th·ªëng**
```bash
# C√†i ƒë·∫∑t dependencies
npm install

# Kh·ªüi ƒë·ªông MongoDB (Windows)
net start MongoDB

# Ch·∫°y server
npm run start
```

### **2. Fetch d·ªØ li·ªáu t·ª´ API**
```bash
# L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ provinces.open-api.vn (depth=3, c·∫•u tr√∫c 3 c·∫•p c≈©)
npm run fetch
```

### **3. Import v√†o MongoDB**
```bash
# Import d·ªØ li·ªáu v√†o database
npm run import-units
```

### **4. Ch·∫°y cron job t·ª± ƒë·ªông**
```bash
# T·ª± ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu h√†ng ng√†y l√∫c 3:00 AM
npm run schedule
```

## üìÅ C·∫•u tr√∫c d·ª± √°n chi ti·∫øt

```
AdministrativeBoundaries/
‚îú‚îÄ‚îÄ üìÅ server/                           # Core API server
‚îÇ   ‚îú‚îÄ‚îÄ index.js                         # Mount v1 and v2 routers, error handlers
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ v1/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js                     # Router g·ªôp cho v1
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ controllers/              # Business logic layer (v1 - 3 c·∫•p)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provinceController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ districtController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ communeController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ unitController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convertController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ searchController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ treeController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ routes/                   # API endpoints routing (v1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provinces.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ districts.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ communes.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ units.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tree.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ models/                   # MongoDB schemas (shared for v1/v2)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Unit.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UnitHistory.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ middleware/               # Middlewares (v1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validateUnit.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cacheMiddleware.js       # placeholder
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ utils/                    # Utilities (v1)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ scripts/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ importUnits.js           # Import d·ªØ li·ªáu v1 (depth=3)
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ v2/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js                     # placeholder (router t·ªïng v2 n·∫øu c·∫ßn)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ controllers/              # Business logic layer (v2 - 2 c·∫•p)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provinceController.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ communeController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ routes/                   # API endpoints routing (v2)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provinces.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ communes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ utils/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loader.js                # N·∫°p cache t·ª´ full-address-v2.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ scripts/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ importUnits.js           # (b·∫£n v2 trong th∆∞ m·ª•c n√†y)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ scripts copy/importUnits.js
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ scripts/
‚îÇ       ‚îî‚îÄ‚îÄ importUnits.v2.js            # Import d·ªØ li·ªáu v2 (depth=2)
‚îú‚îÄ‚îÄ üìÅ fetcher/                          # Data fetching system
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ v1/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js                     # Fetch depth=3 ‚Üí data/full-address.json
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ v2/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js                     # Fetch depth=2 ‚Üí data/full-address-v2.json
‚îÇ   ‚îú‚îÄ‚îÄ schedule.js                      # Cron 03:00 g·ªçi fetch v1
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ utils/                         # (placeholder)
‚îú‚îÄ‚îÄ üìÅ data/                             # Data storage
‚îÇ   ‚îú‚îÄ‚îÄ full-address.json                # V1 JSON (depth=3)
‚îÇ   ‚îú‚îÄ‚îÄ full-address-v2.json             # V2 JSON (depth=2)
‚îÇ   ‚îú‚îÄ‚îÄ full-address-backup.json         # Backup
‚îÇ   ‚îú‚îÄ‚îÄ history.json                     # Nh·∫≠t k√Ω thao t√°c JSON
‚îÇ   ‚îú‚îÄ‚îÄ units.json                       # Backup units
‚îÇ   ‚îú‚îÄ‚îÄ fetch.log                        # Log fetch operations
‚îÇ   ‚îî‚îÄ‚îÄ snapshots/                       # Snapshot d·ªØ li·ªáu (n·∫øu d√πng)
‚îú‚îÄ‚îÄ üìÅ tests/                            # Comprehensive test suite
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ server/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ units.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ communes.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ provinces.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convert.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ search.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ unitController.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ integration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fullFlow.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ syncJsonMongo.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ middleware/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validateUnit.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cacheMiddleware.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ finder.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loader.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ response.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ scripts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ importAddress.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ importUnits.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ fetcher/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schedule.test.js
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ performance/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bulkInsert.test.js
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ utils/
‚îÇ       ‚îî‚îÄ‚îÄ testCleanup.js
‚îú‚îÄ‚îÄ üìÅ utils/                            # Shared utilities
‚îÇ   ‚îú‚îÄ‚îÄ file.js
‚îÇ   ‚îî‚îÄ‚îÄ logger.js
‚îú‚îÄ‚îÄ üìÅ coverage/
‚îÇ   ‚îú‚îÄ‚îÄ lcov-report/
‚îÇ   ‚îú‚îÄ‚îÄ clover.xml
‚îÇ   ‚îú‚îÄ‚îÄ coverage-final.json
‚îÇ   ‚îî‚îÄ‚îÄ lcov.info
‚îú‚îÄ‚îÄ server.js                            # Express app setup (mount v1/v2, errors)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ jest.config.js
‚îú‚îÄ‚îÄ jest.setup.js
‚îú‚îÄ‚îÄ jest.global-setup.js
‚îú‚îÄ‚îÄ jest.global-teardown.js
‚îú‚îÄ‚îÄ cross-env
‚îú‚îÄ‚îÄ docs.txt
‚îú‚îÄ‚îÄ tests.txt
‚îî‚îÄ‚îÄ README.md
```

## üîß API Endpoints chi ti·∫øt

### **Provinces (T·ªânh/Th√†nh ph·ªë)**
```http
GET /provinces
```
**M√¥ t·∫£**: Tr·∫£ v·ªÅ danh s√°ch t·∫•t c·∫£ t·ªânh/th√†nh ph·ªë  
**Logic**: ∆Øu ti√™n MongoDB, fallback JSON n·∫øu MongoDB r·ªóng  
**Response**: Array c√°c t·ªânh v·ªõi code, name, administrativeLevel

### **Communes (X√£/Ph∆∞·ªùng) - CRUD ƒë·∫ßy ƒë·ªß**
```http
GET    /communes                           # T·∫•t c·∫£ x√£/ph∆∞·ªùng
GET    /communes/:provinceID               # X√£/ph∆∞·ªùng theo t·ªânh
GET    /communes/deleted/list              # Danh s√°ch communes ƒë√£ x√≥a
GET    /communes/history                   # L·ªãch s·ª≠ thay ƒë·ªïi t·ª´ unit_histories
GET    /communes/history/:communeCode      # L·ªãch s·ª≠ commune c·ª• th·ªÉ
POST   /communes                           # T·∫°o commune m·ªõi
POST   /communes/:communeCode              # C·∫≠p nh·∫≠t commune
PUT    /communes/:communeCode              # T·∫°o commune m·ªõi (alternative)
DELETE /communes/:communeCode              # Soft delete commune
POST   /communes/:communeCode/restore      # Kh√¥i ph·ª•c commune ƒë√£ x√≥a
```
**T√≠nh nƒÉng ƒë·∫∑c bi·ªát**:
- Soft delete v·ªõi l∆∞u l·ªãch s·ª≠ v√†o MongoDB v√† JSON
- Restore t·ª´ l·ªãch s·ª≠
- T·ª± ƒë·ªông c·∫≠p nh·∫≠t c·∫£ MongoDB v√† JSON files
- L∆∞u history v√†o unit_histories collection

### **Districts (Qu·∫≠n/Huy·ªán) - CRUD ƒë·∫ßy ƒë·ªß**
```http
GET    /districts                       # T·∫•t c·∫£ qu·∫≠n/huy·ªán
GET    /districts/:districtCode         # Chi ti·∫øt qu·∫≠n/huy·ªán
GET    /districts/deleted/list          # Danh s√°ch qu·∫≠n/huy·ªán ƒë√£ x√≥a
POST   /districts                       # T·∫°o qu·∫≠n/huy·ªán m·ªõi
PUT    /districts/:districtCode         # C·∫≠p nh·∫≠t qu·∫≠n/huy·ªán
DELETE /districts/:districtCode         # Soft delete qu·∫≠n/huy·ªán
POST   /districts/:districtCode/restore # Kh√¥i ph·ª•c qu·∫≠n/huy·ªán ƒë√£ x√≥a
```
**ƒê·∫∑c ƒëi·ªÉm**: C√πng c∆° ch·∫ø soft delete/restore nh∆∞ communes; expose ƒë·∫ßy ƒë·ªß REST methods

### **Units (CRUD Operations)**
```http
GET    /units                    # Danh s√°ch ƒë∆°n v·ªã
POST   /units                    # T·∫°o ƒë∆°n v·ªã m·ªõi (v·ªõi validation)
GET    /units/:code              # Chi ti·∫øt ƒë∆°n v·ªã
PUT    /units/:code              # C·∫≠p nh·∫≠t ƒë∆°n v·ªã
DELETE /units/:code              # X√≥a ƒë∆°n v·ªã
GET    /units/:code/history      # L·ªãch s·ª≠ thay ƒë·ªïi
POST   /units/:code/restore      # Kh√¥i ph·ª•c t·ª´ l·ªãch s·ª≠
```
**Validation**: Middleware validateUnit ki·ªÉm tra name, code, level  
**Dual Storage**: C·∫≠p nh·∫≠t c·∫£ MongoDB v√† JSON files  
**History Tracking**: M·ªçi thay ƒë·ªïi ƒë∆∞·ª£c l∆∞u v√†o UnitHistory

### **Convert (Chuy·ªÉn ƒë·ªïi ƒë·ªãa ch·ªâ)**
```http
POST /convert
Content-Type: application/json

{
  "address": "T·ªânh H√† N·ªôi, Ph∆∞·ªùng Ho√†n Ki·∫øm"
}
```
**M√¥ t·∫£**: Parse ƒë·ªãa ch·ªâ t·ª± nhi√™n th√†nh m√£ h√†nh ch√≠nh  
**Logic**: 
1. Chu·∫©n h√≥a chu·ªói (remove diacritics, normalize)
2. T√¨m ki·∫øm trong MongoDB tr∆∞·ªõc
3. Fallback JSON n·∫øu kh√¥ng t√¨m th·∫•y
4. Tr·∫£ v·ªÅ province/commune codes v√† names

### **Search (T√¨m ki·∫øm)**
```http
GET /search?name=H√† N·ªôi&level=province&code=01
```
**M√¥ t·∫£**: T√¨m ki·∫øm units theo nhi·ªÅu ti√™u ch√≠  
**Query params**: name (regex), level, code  
**Limit**: 50 results ƒë·ªÉ tr√°nh overload

### **Tree (C√¢y ph√¢n c·∫•p)**
```http
GET /tree
```
**M√¥ t·∫£**: T·∫°o c√¢y ph√¢n c·∫•p h√†nh ch√≠nh t·ª´ MongoDB  
**Logic**: Build tree structure d·ª±a tr√™n parentCode relationships

## üóÑÔ∏è Database Schema

### **Unit Collection**
```javascript
{
  name: String,                    // T√™n ƒë∆°n v·ªã
  code: String (unique),          // M√£ ƒë∆°n v·ªã
  level: String,                  // C·∫•p: province/district/commune
  parentCode: String,             // M√£ ƒë∆°n v·ªã cha
  provinceCode: String,           // M√£ t·ªânh
  provinceName: String,           // T√™n t·ªânh
  boundary: Object,              // Ranh gi·ªõi ƒë·ªãa l√Ω
  createdAt: Date,
  updatedAt: Date,
  history: Array                  // L·ªãch s·ª≠ thay ƒë·ªïi
}
```

### **UnitHistory Collection**
```javascript
{
  code: String,                   // M√£ ƒë∆°n v·ªã
  action: String,                 // create/update/delete/restore
  oldData: Object,                // D·ªØ li·ªáu c≈©
  newData: Object,                // D·ªØ li·ªáu m·ªõi
  changedAt: Date,                // Th·ªùi ƒëi·ªÉm thay ƒë·ªïi
  changedBy: String,               // Ng∆∞·ªùi thay ƒë·ªïi
  deleted: Boolean                // ƒê√°nh d·∫•u x√≥a
}
```

## ‚öôÔ∏è C·∫•u h√¨nh m√¥i tr∆∞·ªùng

T·∫°o file `.env`:
```env
# MongoDB
MONGODB_URI=mongodb://127.0.0.1:27017/administrative_boundaries

# API Configuration
API_BASE=https://production.cas.so/address-kit
EFFECTIVE_DATE=latest

# Server
PORT=3000
```

## üß™ Testing System chi ti·∫øt

### **Test Structure**
```
tests/
‚îú‚îÄ‚îÄ server/           # API endpoint tests (8 files)
‚îú‚îÄ‚îÄ integration/      # End-to-end tests (2 files)
‚îú‚îÄ‚îÄ middleware/       # Middleware tests (3 files)
‚îú‚îÄ‚îÄ utils/           # Utility function tests (6 files)
‚îú‚îÄ‚îÄ scripts/         # Import script tests (2 files)
‚îú‚îÄ‚îÄ fetcher/         # Data fetching tests (2 files)
‚îú‚îÄ‚îÄ performance/     # Performance tests (1 file)
‚îî‚îÄ‚îÄ utils/           # Test utilities (1 file)
```

### **Ch·∫°y tests**
```bash
# Ch·∫°y t·∫•t c·∫£ tests
npm test

# Ch·∫°y v·ªõi coverage
npm run test:coverage

# Ch·∫°y test c·ª• th·ªÉ
npm test -- --testNamePattern="Units API"

# Debug mode
npm run test:debug
```

### **Test Coverage chi ti·∫øt**
- **Server APIs**: 
  - `units.test.js` (700+ lines) - CRUD operations
  - `communes.test.js` - Commune operations v·ªõi soft delete
  - `provinces.test.js` - Province operations
  - `convert.test.js` - Address conversion
  - `search.test.js` - Search functionality
  - `tree.test.js` - Tree structure building
  - `history.test.js` - History tracking
  - `unitController.test.js` - Controller logic

- **Integration Tests**:
  - `fullFlow.test.js` - End-to-end workflow testing
  - `syncJsonMongo.test.js` - JSON-MongoDB synchronization

- **Middleware Tests**:
  - `validateUnit.test.js` - Input validation
  - `errorHandler.test.js` - Error handling
  - `cacheMiddleware.test.js` - Caching (placeholder)

- **Utils Tests**:
  - `db.test.js` - Database connection
  - `file.test.js` - File operations
  - `finder.test.js` - Tree building utility
  - `loader.test.js` - Data loading
  - `logger.test.js` - Logging system
  - `response.test.js` - Response formatting

- **Scripts Tests**:
  - `importAddress.test.js` - Address import script
  - `importUnits.test.js` - Units import script

- **Fetcher Tests**:
  - `index.test.js` - Data fetching functionality
  - `schedule.test.js` - Cron job testing

- **Performance Tests**:
  - `bulkInsert.test.js` - Bulk operations performance

### **Test Configuration**
- **Environment**: Node.js v·ªõi Jest
- **Database**: MongoDB Memory Server cho tests
- **Mocking**: Jest mocks cho file operations
- **Coverage**: HTML, XML, JSON, LCOV formats
- **Timeout**: 30 seconds per test
- **Cleanup**: Automatic cleanup after each test

### **Test Features**
- **Isolated Tests**: M·ªói test ch·∫°y ƒë·ªôc l·∫≠p
- **Mock Data**: S·ª≠ d·ª•ng test data thay v√¨ real data
- **Error Testing**: Test error scenarios
- **Performance Testing**: Bulk operations
- **Integration Testing**: Full workflow testing

## üìä Data Files & Monitoring

### **Data Files Structure**

#### **full-address.json** (ngu·ªìn provinces.open-api.vn)
```json
[
  {
    "name": "Th√†nh ph·ªë H√† N·ªôi",
    "code": 1,
    "codename": "thanh_pho_ha_noi",
    "division_type": "t·ªânh",
    "districts": [
      {
        "name": "Qu·∫≠n Ba ƒê√¨nh",
        "code": 1,
        "wards": [
          { "name": "Ph∆∞·ªùng Ph√∫c X√°", "code": 1 },
          { "name": "Ph∆∞·ªùng Tr√∫c B·∫°ch", "code": 4 }
        ]
      }
    ]
  }
]
```
**M√¥ t·∫£**: D·ªØ li·ªáu ch√≠nh ch·ª©a 63 t·ªânh/th√†nh v√† ƒë·∫ßy ƒë·ªß qu·∫≠n/huy·ªán, ph∆∞·ªùng/x√£  
**C·∫•u tr√∫c**: 3 c·∫•p: province ‚Üí districts ‚Üí wards (map th√†nh communes trong h·ªá th·ªëng)  
**Ngu·ªìn**: `https://provinces.open-api.vn/api/v1/?depth=3`

#### **history.json** (256 lines)
```json
[
  {
    "action": "deleted",
    "deletedAt": "2025-10-24T03:40:48.147Z",
    "deletedBy": "system",
    "data": {
      "name": "Ph∆∞·ªùng C·∫ßn X√≥a",
      "code": "01001300",
      "level": "commune",
      "parentCode": "01001"
    }
  }
]
```
**M√¥ t·∫£**: L·ªãch s·ª≠ c√°c thao t√°c x√≥a communes  
**C·∫•u tr√∫c**: Array c√°c records v·ªõi action, timestamp, v√† data  
**M·ª•c ƒë√≠ch**: Backup v√† audit trail cho soft delete operations

#### **fetch.log** (187 lines)
```
[2025-10-21T08:07:08.788Z] INFO: üîÅ B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu h√†nh ch√≠nh...
[2025-10-21T08:07:09.278Z] INFO: ‚úÖ L·∫•y 34 t·ªânh/th√†nh
[2025-10-21T08:07:14.061Z] INFO: üíæ ƒê√£ l∆∞u d·ªØ li·ªáu v√†o C:\Users\Quy\Desktop\AlojoBooking\AdministrativeBoundaries\data\full-address.json
```
**M√¥ t·∫£**: Log c√°c operations fetch d·ªØ li·ªáu t·ª´ API  
**Format**: Timestamp + Level + Message  
**M·ª•c ƒë√≠ch**: Tracking fetch operations v√† debugging

#### **units.json**
**M√¥ t·∫£**: Backup file cho units data  
**M·ª•c ƒë√≠ch**: Fallback data cho import operations

#### **full-address-backup.json**
**M√¥ t·∫£**: Backup c·ªßa full-address.json  
**M·ª•c ƒë√≠ch**: Safety backup tr∆∞·ªõc khi update

### **Logging System**

#### **Logger (utils/logger.js)**
```javascript
export const logInfo = (msg) => log(`INFO: ${msg}`);
export const logError = (msg) => log(`ERROR: ${msg}`);
```
**Features**:
- Timestamped logs
- File v√† console output
- Info v√† Error levels
- Automatic log file creation

#### **Log Files**
- `data/fetch.log` - Log fetch operations v·ªõi timestamp
- Console logs v·ªõi emoji indicators
- Error logs v·ªõi stack traces (development mode)

### **Health Check**
```http
GET /
```
**Response**:
```json
{
  "message": "üåè Administrative Boundaries API running successfully!",
  "endpoints": {
    "provinces": "/provinces",
    "communes": "/communes",
    "districts": "/districts",
    "convert": "/convert",
    "search": "/search",
    "tree": "/tree",
    "units": "/units"
  }
}
```
**M·ª•c ƒë√≠ch**: API status check v√† endpoint listing

## üîÑ Data Flow chi ti·∫øt

### **1. Fetch Process (L·∫•y d·ªØ li·ªáu t·ª´ API)**
```
External API (provinces.open-api.vn depth=3) ‚Üí fetcher/index.js ‚Üí data/full-address.json
```
**Chi ti·∫øt**:
- G·ªçi API `https://provinces.open-api.vn/api/v1/?depth=3`
- L·∫•y danh s√°ch 63 t·ªânh/th√†nh ph·ªë c√πng ƒë·∫ßy ƒë·ªß districts v√† wards
- L∆∞u to√†n b·ªô v√†o `data/full-address.json`
- Log operations v√†o `data/fetch.log`

### **2. Import Process (Import v√†o MongoDB)**
```
JSON File ‚Üí scripts/importUnits.js ‚Üí MongoDB Unit Collection
```
**Chi ti·∫øt**:
- ƒê·ªçc `data/full-address.json` (province/district/ward)
- Map ward ‚Üí commune khi import
- T·∫°o `uniqueKey = level + '-' + code` v√† t·∫°o unique index cho tr∆∞·ªùng n√†y
- `code` kh√¥ng c√≤n unique; x·ª≠ l√Ω tr√πng code theo t·ª´ng c·∫•p b·∫±ng `uniqueKey`
- Import theo th·ª© t·ª±: province ‚Üí district ‚Üí commune; clear d·ªØ li·ªáu c≈© tr∆∞·ªõc khi import

### **3. API Request Flow (Lu·ªìng x·ª≠ l√Ω request)**
```
Client Request ‚Üí Express Router ‚Üí Middleware ‚Üí Controller ‚Üí MongoDB/JSON ‚Üí Response
```
**Chi ti·∫øt**:
- **Router**: Route requests ƒë·∫øn ƒë√∫ng controller
- **Middleware**: validateUnit, errorHandler, cacheMiddleware
- **Controller**: Business logic, dual storage (MongoDB + JSON fallback)
- **Models**: Unit, UnitHistory, Address schemas
- **Response**: JSON response v·ªõi proper error handling

### **4. Auto Sync Process (ƒê·ªìng b·ªô t·ª± ƒë·ªông)**
```
Cron Job (3:00 AM) ‚Üí fetcher/schedule.js ‚Üí fetchAllData() ‚Üí Update JSON ‚Üí Log
```
**Chi ti·∫øt**:
- S·ª≠ d·ª•ng `node-cron` v·ªõi schedule `"0 3 * * *"`
- Ch·∫°y `fetcher/index.js` ƒë·ªÉ l·∫•y data m·ªõi
- C·∫≠p nh·∫≠t `data/full-address.json`
- Log v√†o `data/fetch.log`
- Kh√¥ng t·ª± ƒë·ªông sync MongoDB (c·∫ßn manual import)

### **5. CRUD Operations Flow (Lu·ªìng CRUD)**
```
Create/Update/Delete ‚Üí Controller ‚Üí MongoDB + JSON + History
```
**Chi ti·∫øt**:
- **Create**: L∆∞u v√†o MongoDB, JSON, v√† t·∫°o history record
- **Update**: C·∫≠p nh·∫≠t MongoDB, JSON, v√† l∆∞u old/new data v√†o history
- **Delete**: Soft delete v·ªõi isDeleted flag, l∆∞u v√†o history v√† JSON backup
- **Restore**: Kh√¥i ph·ª•c t·ª´ history, c·∫≠p nh·∫≠t c·∫£ MongoDB v√† JSON

### **6. Error Handling Flow (X·ª≠ l√Ω l·ªói)**
```
Error ‚Üí errorHandler.js ‚Üí Log ‚Üí Structured Response
```
**Chi ti·∫øt**:
- Global error handler catch t·∫•t c·∫£ errors
- Ph√¢n lo·∫°i errors (ValidationError, MongoError, etc.)
- Log chi ti·∫øt cho debugging
- Tr·∫£ v·ªÅ structured error response
- Development mode: include stack trace

## üöÄ Deployment

### **Production Setup**
1. **MongoDB**: C√†i ƒë·∫∑t v√† kh·ªüi ƒë·ªông MongoDB
2. **Environment**: C·∫•u h√¨nh `.env` file
3. **Data**: Ch·∫°y `npm run fetch` ƒë·ªÉ l·∫•y d·ªØ li·ªáu
4. **Import**: Ch·∫°y `npm run import-units` ƒë·ªÉ import v√†o DB
5. **Server**: Ch·∫°y `npm run start` ƒë·ªÉ kh·ªüi ƒë·ªông API
6. **Cron**: Ch·∫°y `npm run schedule` ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t

### **Docker Support** (T√πy ch·ªçn)
```dockerfile
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

## üìà Performance

### **Optimizations**
- **Dual Storage**: MongoDB + JSON fallback
- **Indexing**: MongoDB indexes cho t√¨m ki·∫øm nhanh
- **Caching**: Middleware cache cho requests
- **Bulk Operations**: Batch insert/update

### **Benchmarks**
- **API Response**: < 100ms cho simple queries
- **Bulk Import**: ~1000 records/second
- **Search**: < 50ms v·ªõi MongoDB indexes

## üîí Security

### **Input Validation**
- Validate t·∫•t c·∫£ input parameters
- Sanitize string inputs
- Check data types v√† formats

### **Error Handling**
- Global error handler
- Structured error responses
- Logging t·∫•t c·∫£ errors

## üîß Key Components chi ti·∫øt

### **Controllers (Business Logic)**

#### **provinceController.js**
- **Function**: `getProvinces()`
- **Logic**: Dual storage - MongoDB first, JSON fallback
- **Features**: Error handling, logging, data transformation

#### **communeController.js** 
- **Functions**: 
  - `getCommunes()` - L·∫•y communes theo province ho·∫∑c t·∫•t c·∫£
  - `createCommune()` - T·∫°o commune m·ªõi v·ªõi validation
  - `updateCommune()` - C·∫≠p nh·∫≠t commune
  - `deleteCommune()` - Soft delete v·ªõi history tracking
  - `restoreCommune()` - Kh√¥i ph·ª•c t·ª´ soft delete
  - `getDeletedCommunes()` - L·∫•y danh s√°ch ƒë√£ x√≥a
  - `getHistoryCommunes()` - L·∫•y l·ªãch s·ª≠ thay ƒë·ªïi
  - `getHistoryByCode()` - L·ªãch s·ª≠ commune c·ª• th·ªÉ
- **Features**: Soft delete, history tracking, dual storage sync

#### **unitController.js**
- **Functions**:
  - `createUnit()` - T·∫°o unit m·ªõi v·ªõi validation
  - `updateUnit()` - C·∫≠p nh·∫≠t unit
  - `deleteUnit()` - X√≥a unit v·ªõi history
  - `getUnitById()` - L·∫•y chi ti·∫øt unit
  - `getHistory()` - L·ªãch s·ª≠ thay ƒë·ªïi
  - `restoreFromHistory()` - Kh√¥i ph·ª•c t·ª´ history
- **Features**: CRUD operations, history tracking, JSON fallback

#### **convertController.js**
- **Function**: `convertAddress()`
- **Logic**: Parse ƒë·ªãa ch·ªâ t·ª± nhi√™n th√†nh m√£ h√†nh ch√≠nh
- **Features**: String normalization, dual storage search, regex matching

#### **searchController.js**
- **Function**: `searchUnits()`
- **Features**: Multi-criteria search, regex support, result limiting

#### **treeController.js**
- **Function**: `getTree()`
- **Logic**: Build hierarchical tree t·ª´ flat data
- **Features**: Parent-child relationships, tree structure

### **Models (Database Schemas)**

#### **Unit.js**
```javascript
{
  name: String,                    // T√™n ƒë∆°n v·ªã
  code: String (unique),          // M√£ ƒë∆°n v·ªã
  level: String,                  // C·∫•p: province/district/commune
  parentCode: String,             // M√£ ƒë∆°n v·ªã cha
  provinceCode: String,           // M√£ t·ªânh
  provinceName: String,           // T√™n t·ªânh
  boundary: Object,              // Ranh gi·ªõi ƒë·ªãa l√Ω
  createdAt: Date,
  updatedAt: Date,
  history: Array,                // L·ªãch s·ª≠ thay ƒë·ªïi
  isDeleted: Boolean,            // Soft delete flag
  deletedAt: Date                // Th·ªùi ƒëi·ªÉm x√≥a
}
```

#### **UnitHistory.js**
```javascript
{
  code: String,                   // M√£ ƒë∆°n v·ªã
  action: String,                 // create/update/delete/restore
  oldData: Object,                // D·ªØ li·ªáu c≈©
  newData: Object,                // D·ªØ li·ªáu m·ªõi
  changedAt: Date,                // Th·ªùi ƒëi·ªÉm thay ƒë·ªïi
  changedBy: String,              // Ng∆∞·ªùi thay ƒë·ªïi
  deleted: Boolean                // ƒê√°nh d·∫•u x√≥a
}
```

#### **Address.js**
- Kh√¥ng s·ª≠ d·ª•ng trong phi√™n b·∫£n hi·ªán t·∫°i

### **Middleware**

#### **validateUnit.js**
- **Function**: Validate input data
- **Checks**: name, code, level fields
- **Error Handling**: Structured error responses

#### **errorHandler.js**
- **Functions**: `notFoundHandler()`, `errorHandler()`
- **Features**: Global error handling, error classification, logging
- **Error Types**: ValidationError, MongoError, CastError, etc.

#### **cacheMiddleware.js**
- **Status**: Empty file (placeholder for future implementation)

### **Utils**

#### **db.js**
- **Function**: `connectDB()`
- **Features**: MongoDB connection, error handling, environment config

#### **finder.js**
- **Function**: `buildTree()`
- **Logic**: Convert flat array to hierarchical tree structure
- **Features**: Parent-child relationship building

#### **loader.js**
- **Function**: `loadData()`
- **Features**: Load JSON data from file system

#### **response.js**
- **Status**: Empty file (placeholder)

### **Scripts**

#### **importUnits.js** (c·∫≠p nh·∫≠t theo d·ªØ li·ªáu 63 t·ªânh - 3 c·∫•p)
- **Function**: Import JSON data (depth=3) v√†o MongoDB `Unit`
- **Ngu·ªìn d·ªØ li·ªáu**: `data/full-address.json` l·∫•y t·ª´ API provinces.open-api.vn
- **Mapping**:
  - Province ‚Üí level="province"
  - Districts ‚Üí level="district", `parentCode` = `province.code`
  - Wards (API) ‚Üí map th√†nh level="commune", `parentCode` = `district.code`
- **Kh√≥a duy nh·∫•t**: `uniqueKey = level + '-' + code`; `code` kh√¥ng c√≤n unique
- **Quy tr√¨nh**: Clear to√†n b·ªô ‚Üí t·∫°o index cho `uniqueKey` ‚Üí import theo th·ª© t·ª± province ‚Üí district ‚Üí commune

#### **importAddress.js**
- **Function**: Import JSON data to MongoDB Address collection
- **Features**: Similar to importUnits but for Address schema
- **Process**: Clear old data ‚Üí Import all levels to Address collection

### **Fetcher**

#### **index.js** (fetcher)
- **Function**: `fetchAllData()` t·∫£i 63 t·ªânh/th√†nh v·ªõi 3 c·∫•p ƒë·ªô (province/district/ward)
- **API**: `https://provinces.open-api.vn/api/v1/?depth=3`
- **Output**: L∆∞u to√†n b·ªô JSON v√†o `data/full-address.json`

#### **schedule.js**
- **Function**: Cron job setup
- **Schedule**: Daily at 3:00 AM
- **Features**: Environment-aware, error handling

## üìù Changelog

### **v1.0.0** (Current)
- ‚úÖ Core API endpoints v·ªõi dual storage
- ‚úÖ MongoDB integration v·ªõi fallback JSON
- ‚úÖ CRUD operations v·ªõi history tracking
- ‚úÖ Soft delete v√† restore functionality
- ‚úÖ Auto sync v·ªõi cron job
- ‚úÖ Comprehensive testing (100% coverage)
- ‚úÖ Address conversion system
- ‚úÖ Search v√† tree building
- ‚úÖ Error handling v√† logging
- ‚úÖ Performance optimization

## ü§ù Contributing

1. Fork repository
2. T·∫°o feature branch
3. Commit changes
4. Push to branch
5. T·∫°o Pull Request

## üìÑ License

ISC License

## üë• Support

- **Issues**: T·∫°o issue tr√™n GitHub
- **Documentation**: Xem `docs.txt` cho chi ti·∫øt
- **API Docs**: Ch·∫°y server v√† truy c·∫≠p `http://localhost:3000`

---

**üåè Administrative Boundaries API** - Qu·∫£n l√Ω d·ªØ li·ªáu h√†nh ch√≠nh Vi·ªát Nam m·ªôt c√°ch hi·ªáu qu·∫£ v√† tin c·∫≠y.

## üìö Ph·ª• l·ª•c: Chi ti·∫øt folder ‚Üí file ‚Üí ch·ª©c nƒÉng

L∆∞u √Ω: Danh s√°ch d∆∞·ªõi ƒë√¢y li·ªát k√™ t·ª´ng file ch√≠nh trong d·ª± √°n v√† m√¥ t·∫£ ng·∫Øn g·ªçn ch·ª©c nƒÉng, k√®m c√°c h√†m/export ti√™u bi·ªÉu (n·∫øu c√≥).

### 1) Root
- `server.js`: Kh·ªüi t·∫°o Express, n·∫°p bi·∫øn m√¥i tr∆∞·ªùng, k·∫øt n·ªëi MongoDB (`connectDB()`), g·∫Øn router `v1` v√† `v2`, n·∫°p cache `v2` (`loadV2Cache()`), c·∫•u h√¨nh `notFoundHandler` v√† `errorHandler`, l·∫Øng nghe c·ªïng.
- `package.json`: Scripts (test, start, fetch, import, schedule), dependencies (express, mongoose, node-fetch, node-cron, dotenv).
- `Dockerfile`: C·∫•u h√¨nh image Node 18, c√†i dependencies v√† ch·∫°y server.
- `docker-compose.yml`: (N·∫øu d√πng) setup d·ªãch v·ª• container (kh√¥ng b·∫Øt bu·ªôc).
- `README.MD`: T√†i li·ªáu d·ª± √°n (file n√†y).
- `docs.txt`, `tests.txt`: Ghi ch√∫ ph√°t tri·ªÉn v√† t√≥m t·∫Øt tests.
- `.env` (kh√¥ng commit): C·∫•u h√¨nh m√¥i tr∆∞·ªùng (MONGODB_URI, PORT,...).

### 2) Data
- `data/full-address.json`: D·ªØ li·ªáu provinces API (depth=3: province ‚Üí districts ‚Üí communes/wards) cho phi√™n b·∫£n v1.
- `data/full-address-v2.json`: D·ªØ li·ªáu provinces API (depth=2: province ‚Üí wards) cho phi√™n b·∫£n v2 (map ward ‚Üí commune).
- `data/history.json`: Nh·∫≠t k√Ω thao t√°c (soft delete, restore) d·∫°ng JSON.
- `data/units.json`: Backup units (fallback/ph·ª•c h·ªìi).
- `data/fetch.log`: Log thao t√°c fetch theo th·ªùi gian.
- `data/snapshots/`: Th∆∞ m·ª•c snapshot (l∆∞u theo th·ªùi ƒëi·ªÉm, n·∫øu d√πng).

### 3) Shared utils
- `utils/file.js`
  - `saveJSON(path, data)`: Ghi ƒë·ªëi t∆∞·ª£ng v√†o JSON.
  - `loadJSON(path)`: ƒê·ªçc file JSON th√†nh object/array.
- `utils/logger.js`
  - `logInfo(msg)`, `logError(msg)`: Ghi log ƒë·ªãnh d·∫°ng `[ISO_TIMESTAMP] LEVEL: message` v√†o `data/fetch.log` v√† console.

### 4) Fetcher
- `fetcher/v1/index.js`
  - H√ÄM: `fetchAllData()` g·ªçi `https://provinces.open-api.vn/api/v1/?depth=3` ‚Üí l∆∞u `data/full-address.json` (v1) v√† log ti·∫øn tr√¨nh.
  - Ch·∫°y tr·ª±c ti·∫øp khi g·ªçi file (`node fetcher/v1/index.js`).
- `fetcher/v2/index.js`
  - H√ÄM: `fetchV2()` g·ªçi `https://provinces.open-api.vn/api/v2/?depth=2` ‚Üí l∆∞u `data/full-address-v2.json` (v2) v√† log ti·∫øn tr√¨nh.
  - Export default `fetchV2`; ch·∫°y tr·ª±c ti·∫øp khi g·ªçi file.
- `fetcher/schedule.js`
  - L√™n l·ªãch cron `0 3 * * *` (03:00 AM) g·ªçi `fetchAllData()` (v1). B·ªè qua khi `NODE_ENV=test`.

### 5) Server (v1)
- `server/v1/index.js`: Router g·ªëc cho v1, mount c√°c nh√≥m route: `/provinces`, `/communes`, `/districts`, `/units`, `/search`, `/tree`, `/convert`.

- Controllers (`server/v1/controllers/`)
  - `provinceController.js`
    - `getProvinces(req,res)`: L·∫•y to√†n b·ªô t·ªânh (k√®m 3 c·∫•p) t·ª´ MongoDB (∆∞u ti√™n) ho·∫∑c JSON fallback.
    - `getProvinceByCode(req,res)`: L·∫•y chi ti·∫øt t·ªânh theo `provinceCode` (3 c·∫•p) t·ª´ Mongo ho·∫∑c JSON.
    - `getProvinceById(req,res)`: L·∫•y chi ti·∫øt t·ªânh theo `_id` Mongo (k√®m huy·ªán/x√£).
    - `createProvince(req,res)`: T·∫°o m·ªõi t·ªânh, ƒë·ªìng b·ªô Mongo + c·∫≠p nh·∫≠t JSON.
    - `updateProvince(req,res)`: C·∫≠p nh·∫≠t thu·ªôc t√≠nh t·ªânh, ƒë·ªìng b·ªô JSON.
    - `deleteProvince(req,res)`: Soft delete t·ªânh, l∆∞u `UnitHistory`, c·∫≠p nh·∫≠t JSON.
    - `restoreProvince(req,res)`: Kh√¥i ph·ª•c t·ªânh ƒë√£ x√≥a, th√™m l·∫°i v√†o JSON n·∫øu thi·∫øu.
    - `getDeletedProvinces(req,res)`: Li·ªát k√™ c√°c t·ªânh ƒë√£ x√≥a (soft).
  - `districtController.js`
    - `getDistricts(req,res)`: L·∫•y huy·ªán (to√†n b·ªô/thu·ªôc t·ªânh). Mongo ∆∞u ti√™n, fallback JSON.
    - `getDistrictByCode(req,res)`: Chi ti·∫øt huy·ªán theo `districtCode` t·ª´ Mongo ho·∫∑c JSON.
    - `createDistrict(req,res)`: T·∫°o huy·ªán m·ªõi (Mongo + JSON).
    - `updateDistrict(req,res)`: C·∫≠p nh·∫≠t huy·ªán (Mongo + JSON).
    - `deleteDistrict(req,res)`: Soft delete, l∆∞u history, xo√° trong JSON.
    - `restoreDistrict(req,res)`: G·ª° `isDeleted`, th√™m l·∫°i JSON n·∫øu thi·∫øu.
    - `getDeletedDistricts(req,res)`: Danh s√°ch huy·ªán ƒë√£ x√≥a.
  - `communeController.js`
    - `getCommunes(req,res)`: L·∫•y x√£/ph∆∞·ªùng (to√†n b·ªô/thu·ªôc t·ªânh). Mongo ∆∞u ti√™n, fallback JSON (g·ªôp x√£ d∆∞·ªõi huy·ªán ho·∫∑c tr·ª±c thu·ªôc t·ªânh).
    - `getCommuneByCode(req,res)`: L·∫•y x√£ theo m√£, so kh·ªõp an to√†n b·∫±ng `$expr` (string-compare), fallback JSON.
    - `createCommune(req,res)`: T·∫°o x√£ m·ªõi, sinh `uniqueKey`, c·∫≠p nh·∫≠t JSON ƒë√∫ng c·∫•p cha.
    - `updateCommune(req,res)`: C·∫≠p nh·∫≠t x√£, ƒë·ªìng b·ªô JSON (t√¨m v√† `Object.assign`).
    - `deleteCommune(req,res)`: Soft delete, l∆∞u `UnitHistory`.
    - `restoreCommune(req,res)`: Kh√¥i ph·ª•c x√£ ƒë√£ x√≥a.
    - `getDeletedCommunes(req,res)`: Danh s√°ch x√£ ƒë√£ x√≥a.
    - `getHistoryCommunes(req,res)`: L·ªãch s·ª≠ thay ƒë·ªïi c·∫•p x√£.
    - `getHistoryByCode(req,res)`: L·ªãch s·ª≠ thay ƒë·ªïi theo m√£ x√£.
  - `unitController.js`
    - `createUnit(req,res)`: T·∫°o ƒë∆°n v·ªã (province/commune). Trong test: ch·ªâ Mongo; b√¨nh th∆∞·ªùng: JSON + Mongo + `UnitHistory`.
    - `updateUnit(req,res)`: C·∫≠p nh·∫≠t ƒë∆°n v·ªã. Test: Mongo; b√¨nh th∆∞·ªùng: JSON (t√¨m target) + Mongo (upsert) + `UnitHistory`.
    - `deleteUnit(req,res)`: X√≥a ƒë∆°n v·ªã. Test: x√≥a Mongo; b√¨nh th∆∞·ªùng: x√≥a kh·ªèi JSON, x√≥a Mongo, ghi `UnitHistory`.
    - `getHistory(req,res)`: L·∫•y `UnitHistory` theo code.
    - `restoreFromHistory(req,res)`: Kh√¥i ph·ª•c t·ª´ b·∫£n ghi history, ƒë·ªìng b·ªô JSON + Mongo v√† l∆∞u th√™m b·∫£n ghi `restore`.
    - `getUnitById(req,res)`: L·∫•y chi ti·∫øt ƒë∆°n v·ªã theo `code`, ∆∞u ti√™n Mongo, fallback JSON.
  - `convertController.js`
    - `convertAddress(req,res)`: Chu·∫©n h√≥a chu·ªói, tra MongoDB theo th·ª© t·ª± province ‚Üí district ‚Üí commune; n·∫øu thi·∫øu th√¨ fallback JSON; tr·∫£ v·ªÅ `result` v√† `codes`.
  - `searchController.js`
    - `searchUnits(req,res)`: T√¨m theo `name` (regex), `level`, `code`; gi·ªõi h·∫°n 50.
  - `treeController.js`
    - `getTree(req,res)`: X√¢y c√¢y ph√¢n c·∫•p t·ª´ b·∫£ng `Unit` theo `parentCode`.

- Routes (`server/v1/routes/`)
  - `provinces.js`: Map endpoints ‚Üí provinceController: GET `/`, `/:provinceCode`, `/id/:id`, POST `/`, PUT `/:provinceCode`, DELETE `/:provinceCode`, PATCH `/restore/:provinceCode`, GET `/deleted/list`.
  - `districts.js`: GET `/`, GET `/deleted/list`, GET `/:districtCode`, POST `/`, PUT `/:districtCode`, DELETE `/:districtCode`, POST `/:districtCode/restore`.
  - `communes.js`: GET `/`, GET `/deleted/list`, GET `/history`, GET `/history/:communeCode`, GET `/:communeCode`, POST `/`, POST `/:communeCode`, PUT `/:communeCode`, DELETE `/:communeCode`, POST `/:communeCode/restore`.
  - `units.js`: POST `/`, PUT `/:code`, DELETE `/:code`, GET `/:code`, GET `/:code/history`, POST `/:code/restore`.
  - `convert.js`: POST `/` ‚Üí `convertAddress`.
  - `search.js`: GET `/` ‚Üí `searchUnits`.
  - `tree.js`: GET `/` ‚Üí `getTree`.

- Middleware (`server/v1/middleware/`)
  - `errorHandler.js`
    - `notFoundHandler(req,res)`: Tr·∫£ 404 cho route kh√¥ng t·ªìn t·∫°i.
    - `errorHandler(err,req,res,next)`: Ph√¢n lo·∫°i v√† tr·∫£ l·ªói c√≥ c·∫•u tr√∫c, h·ªó tr·ª£ hi·ªÉn th·ªã stack trong development.
  - `validateUnit.js`: Ki·ªÉm tra body ƒë·∫ßu v√†o v·ªõi c√°c tr∆∞·ªùng `name`, `code`, `level` (province/district/commune).
  - `cacheMiddleware.js`: Placeholder (ch∆∞a tri·ªÉn khai).

- Models (`server/v1/models/`)
  - `Unit.js`: Schema `Unit` (v1/v2 chung), c√°c tr∆∞·ªùng: `schemaVersion`, `name`, `code`, `level`, `parentCode`, `provinceCode`, `provinceName`, `uniqueKey` (unique), `isDeleted`, timestamps, indexes (`schemaVersion, level, parentCode`).
  - `UnitHistory.js`: Schema l·ªãch s·ª≠ thay ƒë·ªïi: `code`, `action` (create/update/delete/restore), `oldData`, `newData`, `deleted`, `changedAt`, `changedBy`, timestamps; index `{ code, changedAt }`.

- Utils (`server/v1/utils/`)
  - `db.js`: `connectDB()` ƒë·ªçc `MONGODB_URI`, k·∫øt n·ªëi mongoose, log tr·∫°ng th√°i.
  - `logger.js`: Re-export `logInfo`, `logError` t·ª´ `utils/logger.js` d√πng chung.

- Scripts (`server/v1/scripts/`)
  - `importUnits.js`: Import d·ªØ li·ªáu t·ª´ `data/full-address.json` ‚Üí MongoDB `Unit` v·ªõi `schemaVersion='v1'`. T·∫°o index, xo√° c≈©, duy·ªát province ‚Üí district ‚Üí commune; t·∫°o `uniqueKey` chu·∫©n ho√°.

### 6) Server (v2)
- Routes (`server/v2/routes/`)
  - `provinces.js`: GET `/` (danh s√°ch t·ªânh v2), GET `/:provinceCode`, GET `/:provinceCode/wards` (proxy sang `getCommunes`), POST `/`, PUT `/:provinceCode`, DELETE `/:provinceCode`.
  - `communes.js`: GET `/`, GET `/:communeCode`, POST `/`, PUT `/:communeCode`, DELETE `/:communeCode`.

- Controllers (`server/v2/controllers/`)
  - `provinceController.js`
    - `getProvinces(req,res)`: L·∫•y t·ªânh t·ª´ Mongo (`schemaVersion='v2'`) ho·∫∑c fallback cache v2.
    - `getProvinceByCode(req,res)`: L·∫•y t·ªânh + `wards` (map th√†nh communes) t·ª´ Mongo; fallback loader cache v2.
    - `createProvince(req,res)`: T·∫°o m·ªõi t·ªânh v2 trong Mongo (t·ªëi gi·∫£n, `uniqueKey` `v2-province-<code>`).
    - `updateProvince(req,res)`: C·∫≠p nh·∫≠t t·ªânh v2 theo code.
    - `deleteProvince(req,res)`: X√≥a t·ªânh v2 v√† c√°c ward (commune) con c√πng `schemaVersion='v2'`.
  - `communeController.js`
    - `getCommunes(req,res)`: L·∫•y to√†n b·ªô x√£ (ward) v2, parent tr·ª±c ti·∫øp l√† province; fallback JSON v2.
    - `getCommuneByCode(req,res)`: L·∫•y x√£ theo m√£, ∆∞u ti√™n Mongo, fallback JSON v2.
    - `createCommune(req,res)`: T·∫°o x√£ (ward) m·ªõi, sinh `uniqueKey` `v2-commune-<code>`, c·∫≠p nh·∫≠t JSON v2.
    - `updateCommune(req,res)`: C·∫≠p nh·∫≠t x√£ (ward) trong Mongo + JSON v2.
    - `deleteCommune(req,res)`: Soft delete + ghi `UnitHistory`.
    - `restoreCommune(req,res)`: Kh√¥i ph·ª•c x√£ ƒë√£ x√≥a (Mongo v2).
    - `getDeletedCommunes/getHistoryCommunes/getHistoryByCode`: T∆∞∆°ng t·ª± v1 nh∆∞ng cho v2.

- Utils (`server/v2/utils/`)
  - `loader.js`
    - `loadV2Cache()`: ƒê·ªçc `data/full-address-v2.json` v√†o cache b·ªô nh·ªõ: provinces, wardsByProvince (Map), wardByCode (Map).
    - `getV2Provinces()`, `getV2ProvinceByCode(code)`, `getV2WardsByProvince(code)`, `getV2WardByCode(code)`: Truy c·∫≠p cache ƒë√£ n·∫°p.

- Kh√°c
  - `server/v2/index.js`: (tr·ªëng/placeholder cho router t·ªïng v2 n·∫øu mu·ªën gom l·∫°i).
  - `server/scripts/importUnits.v2.js`: Import `data/full-address-v2.json` ‚Üí Mongo `Unit` v·ªõi `schemaVersion='v2'`, t·∫°o `uniqueKey` v2 v√† index c·∫ßn thi·∫øt, xo√° d·ªØ li·ªáu v2 c≈© tr∆∞·ªõc khi import.

### 7) Tests (t√≥m t·∫Øt theo th∆∞ m·ª•c)
- `tests/server/*.test.js`: Ki·ªÉm th·ª≠ endpoint API (units, communes, provinces, districts, search, tree, convert, history, unitController logic).
- `tests/integration/*.test.js`: Quy tr√¨nh end-to-end (fullFlow, sync JSON‚ÜîMongo).
- `tests/middleware/*.test.js`: Ki·ªÉm th·ª≠ `validateUnit`, `errorHandler`, `cacheMiddleware` (placeholder).
- `tests/utils/*.test.js`: Ki·ªÉm th·ª≠ `db`, `file`, `finder`, `loader`, `logger`, `response`.
- `tests/scripts/*.test.js`: Ki·ªÉm th·ª≠ import ƒë·ªãa ch·ªâ/ƒë∆°n v·ªã.
- `tests/fetcher/*.test.js`: Ki·ªÉm th·ª≠ fetcher v1 v√† schedule cron.
- `tests/performance/bulkInsert.test.js`: Ki·ªÉm th·ª≠ hi·ªáu nƒÉng bulk insert.
- `jest.config.js`, `jest.setup.js`, `jest.global-setup.js`, `jest.global-teardown.js`: C·∫•u h√¨nh v√† bootstrap Jest, m√¥i tr∆∞·ªùng test.

---

N·∫øu b·∫°n c·∫ßn t√†i li·ªáu chi ti·∫øt h∆°n theo d·∫°ng API reference cho t·ª´ng endpoint/h√†m, ho·∫∑c mu·ªën xu·∫•t HTML docs t·ª± ƒë·ªông (v√≠ d·ª• t·ª´ JSDoc), c√≥ th·ªÉ m·ªü issue ƒë·ªÉ m√¨nh b·ªï sung generator ph√π h·ª£p.