# ğŸŒ Administrative Boundaries API

**API há»‡ thá»‘ng ranh giá»›i hÃ nh chÃ­nh Viá»‡t Nam** - Cung cáº¥p dá»¯ liá»‡u tá»‰nh/thÃ nh phá»‘, quáº­n/huyá»‡n, phÆ°á»ng/xÃ£ vá»›i kháº£ nÄƒng CRUD vÃ  Ä‘á»“ng bá»™ tá»± Ä‘á»™ng.

## ğŸ“‹ Tá»•ng quan dá»± Ã¡n

Dá»± Ã¡n nÃ y xÃ¢y dá»±ng má»™t **API RESTful** Ä‘á»ƒ quáº£n lÃ½ dá»¯ liá»‡u hÃ nh chÃ­nh Viá»‡t Nam, bao gá»“m:
- **34 tá»‰nh/thÃ nh phá»‘**
- **HÃ ng nghÃ¬n quáº­n/huyá»‡n** 
- **HÃ ng chá»¥c nghÃ¬n phÆ°á»ng/xÃ£**

Vá»›i kháº£ nÄƒng tÃ¬m kiáº¿m, chuyá»ƒn Ä‘á»•i Ä‘á»‹a chá»‰, quáº£n lÃ½ lá»‹ch sá»­ vÃ  Ä‘á»“ng bá»™ tá»± Ä‘á»™ng.

## ğŸ—ï¸ Kiáº¿n trÃºc há»‡ thá»‘ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   External API  â”‚    â”‚   Express API   â”‚    â”‚    MongoDB      â”‚
â”‚  (address-kit)  â”‚â”€â”€â”€â–¶â”‚    Server       â”‚â”€â”€â”€â–¶â”‚   Database      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   JSON Backup   â”‚
                       â”‚  (fallback)     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Luá»“ng hoáº¡t Ä‘á»™ng chÃ­nh

### **1. Khá»Ÿi Ä‘á»™ng há»‡ thá»‘ng**
```bash
# CÃ i Ä‘áº·t dependencies
npm install

# Khá»Ÿi Ä‘á»™ng MongoDB (Windows)
net start MongoDB

# Cháº¡y server
npm run start
```

### **2. Fetch dá»¯ liá»‡u tá»« API**
```bash
# Láº¥y dá»¯ liá»‡u má»›i nháº¥t tá»« address-kit API
npm run fetch
```

### **3. Import vÃ o MongoDB**
```bash
# Import dá»¯ liá»‡u vÃ o database
npm run import-units
```

### **4. Cháº¡y cron job tá»± Ä‘á»™ng**
```bash
# Tá»± Ä‘á»™ng cáº­p nháº­t dá»¯ liá»‡u hÃ ng ngÃ y lÃºc 3:00 AM
npm run schedule
```

## ğŸ“ Cáº¥u trÃºc dá»± Ã¡n

```
AdministrativeBoundaries/
â”œâ”€â”€ ğŸ“ server/                    # Core API server
â”‚   â”œâ”€â”€ ğŸ“ controllers/           # Business logic
â”‚   â”‚   â”œâ”€â”€ provinceController.js # Xá»­ lÃ½ tá»‰nh/thÃ nh phá»‘
â”‚   â”‚   â”œâ”€â”€ communeController.js  # Xá»­ lÃ½ xÃ£/phÆ°á»ng
â”‚   â”‚   â”œâ”€â”€ unitController.js     # CRUD Ä‘Æ¡n vá»‹ hÃ nh chÃ­nh
â”‚   â”‚   â”œâ”€â”€ convertController.js  # Chuyá»ƒn Ä‘á»•i Ä‘á»‹a chá»‰
â”‚   â”‚   â”œâ”€â”€ searchController.js   # TÃ¬m kiáº¿m
â”‚   â”‚   â””â”€â”€ treeController.js     # CÃ¢y phÃ¢n cáº¥p
â”‚   â”œâ”€â”€ ğŸ“ models/                # MongoDB schemas
â”‚   â”‚   â”œâ”€â”€ Unit.js              # Schema Ä‘Æ¡n vá»‹ hÃ nh chÃ­nh
â”‚   â”‚   â”œâ”€â”€ UnitHistory.js       # Schema lá»‹ch sá»­ thay Ä‘á»•i
â”‚   â”‚   â””â”€â”€ Address.js           # Schema Ä‘á»‹a chá»‰
â”‚   â”œâ”€â”€ ğŸ“ routes/               # API endpoints
â”‚   â”‚   â”œâ”€â”€ provinces.js         # /provinces
â”‚   â”‚   â”œâ”€â”€ communes.js          # /communes
â”‚   â”‚   â”œâ”€â”€ units.js             # /units (CRUD)
â”‚   â”‚   â”œâ”€â”€ convert.js           # /convert
â”‚   â”‚   â”œâ”€â”€ search.js            # /search
â”‚   â”‚   â””â”€â”€ tree.js              # /tree
â”‚   â”œâ”€â”€ ğŸ“ middleware/           # Middleware functions
â”‚   â”‚   â”œâ”€â”€ validateUnit.js      # Validation input
â”‚   â”‚   â”œâ”€â”€ errorHandler.js      # Xá»­ lÃ½ lá»—i
â”‚   â”‚   â””â”€â”€ cacheMiddleware.js   # Cache layer
â”‚   â”œâ”€â”€ ğŸ“ utils/                # Utility functions
â”‚   â”‚   â”œâ”€â”€ db.js               # Káº¿t ná»‘i MongoDB
â”‚   â”‚   â”œâ”€â”€ finder.js           # TÃ¬m kiáº¿m trong JSON
â”‚   â”‚   â”œâ”€â”€ loader.js           # Load dá»¯ liá»‡u
â”‚   â”‚   â””â”€â”€ response.js         # Format response
â”‚   â””â”€â”€ ğŸ“ scripts/             # Import scripts
â”‚       â”œâ”€â”€ importAddress.js    # Import Ä‘á»‹a chá»‰
â”‚       â””â”€â”€ importUnits.js      # Import Ä‘Æ¡n vá»‹
â”œâ”€â”€ ğŸ“ fetcher/                  # Data fetching
â”‚   â”œâ”€â”€ index.js                # Fetch tá»« API
â”‚   â””â”€â”€ schedule.js             # Cron job
â”œâ”€â”€ ğŸ“ data/                     # Data storage
â”‚   â”œâ”€â”€ full-address.json       # Dá»¯ liá»‡u JSON backup
â”‚   â”œâ”€â”€ fetch.log              # Log fetch operations
â”‚   â””â”€â”€ snapshots/             # Lá»‹ch sá»­ dá»¯ liá»‡u
â”œâ”€â”€ ğŸ“ tests/                    # Test suite
â”‚   â”œâ”€â”€ ğŸ“ server/              # API tests
â”‚   â”œâ”€â”€ ğŸ“ integration/         # Integration tests
â”‚   â”œâ”€â”€ ğŸ“ middleware/          # Middleware tests
â”‚   â”œâ”€â”€ ğŸ“ utils/               # Utility tests
â”‚   â”œâ”€â”€ ğŸ“ scripts/             # Script tests
â”‚   â”œâ”€â”€ ğŸ“ fetcher/             # Fetcher tests
â”‚   â””â”€â”€ ğŸ“ performance/         # Performance tests
â”œâ”€â”€ ğŸ“ utils/                    # Shared utilities
â”‚   â”œâ”€â”€ file.js                 # File operations
â”‚   â””â”€â”€ logger.js               # Logging system
â”œâ”€â”€ ğŸ“ coverage/                # Test coverage reports
â”œâ”€â”€ server.js                   # Main server file
â”œâ”€â”€ package.json                # Dependencies & scripts
â”œâ”€â”€ jest.config.js              # Jest configuration
â””â”€â”€ README.md                   # Documentation
```

## ğŸ”§ API Endpoints

### **Provinces (Tá»‰nh/ThÃ nh phá»‘)**
```http
GET /provinces
```
Tráº£ vá» danh sÃ¡ch táº¥t cáº£ tá»‰nh/thÃ nh phá»‘

### **Communes (XÃ£/PhÆ°á»ng)**
```http
GET /communes                    # Táº¥t cáº£ xÃ£/phÆ°á»ng
GET /communes/:provinceID        # XÃ£/phÆ°á»ng theo tá»‰nh
```

### **Units (CRUD Operations)**
```http
GET    /units                    # Danh sÃ¡ch Ä‘Æ¡n vá»‹
POST   /units                    # Táº¡o Ä‘Æ¡n vá»‹ má»›i
GET    /units/:code              # Chi tiáº¿t Ä‘Æ¡n vá»‹
PUT    /units/:code              # Cáº­p nháº­t Ä‘Æ¡n vá»‹
DELETE /units/:code              # XÃ³a Ä‘Æ¡n vá»‹
GET    /units/:code/history      # Lá»‹ch sá»­ thay Ä‘á»•i
POST   /units/:code/restore      # KhÃ´i phá»¥c tá»« lá»‹ch sá»­
```

### **Convert (Chuyá»ƒn Ä‘á»•i Ä‘á»‹a chá»‰)**
```http
POST /convert
Content-Type: application/json

{
  "address": "Tá»‰nh HÃ  Ná»™i, PhÆ°á»ng HoÃ n Kiáº¿m"
}
```

### **Search (TÃ¬m kiáº¿m)**
```http
GET /search?name=HÃ  Ná»™i&level=province
```

### **Tree (CÃ¢y phÃ¢n cáº¥p)**
```http
GET /tree
```

## ğŸ—„ï¸ Database Schema

### **Unit Collection**
```javascript
{
  name: String,                    // TÃªn Ä‘Æ¡n vá»‹
  code: String (unique),          // MÃ£ Ä‘Æ¡n vá»‹
  level: String,                  // Cáº¥p: province/district/commune
  parentCode: String,             // MÃ£ Ä‘Æ¡n vá»‹ cha
  provinceCode: String,           // MÃ£ tá»‰nh
  provinceName: String,           // TÃªn tá»‰nh
  boundary: Object,              // Ranh giá»›i Ä‘á»‹a lÃ½
  createdAt: Date,
  updatedAt: Date,
  history: Array                  // Lá»‹ch sá»­ thay Ä‘á»•i
}
```

### **UnitHistory Collection**
```javascript
{
  code: String,                   // MÃ£ Ä‘Æ¡n vá»‹
  action: String,                 // create/update/delete/restore
  oldData: Object,                // Dá»¯ liá»‡u cÅ©
  newData: Object,                // Dá»¯ liá»‡u má»›i
  changedAt: Date,                // Thá»i Ä‘iá»ƒm thay Ä‘á»•i
  changedBy: String,               // NgÆ°á»i thay Ä‘á»•i
  deleted: Boolean                // ÄÃ¡nh dáº¥u xÃ³a
}
```

## âš™ï¸ Cáº¥u hÃ¬nh mÃ´i trÆ°á»ng

Táº¡o file `.env`:
```env
# MongoDB
MONGODB_URI=mongodb://127.0.0.1:27017/administrative_boundaries

# API Configuration
API_BASE=https://production.cas.so/address-kit
EFFECTIVE_DATE=latest

# Server
PORT=3000
```

## ğŸ§ª Testing

### **Cháº¡y tests**
```bash
# Cháº¡y táº¥t cáº£ tests
npm test

# Cháº¡y vá»›i coverage
npm run test:coverage

# Cháº¡y test cá»¥ thá»ƒ
npm test -- --testNamePattern="Units API"
```

### **Test Coverage**
- **Server APIs**: 100% coverage cho controllers
- **Middleware**: Validation, error handling
- **Utils**: File operations, database
- **Integration**: Full flow testing
- **Performance**: Bulk operations

## ğŸ“Š Monitoring & Logging

### **Log Files**
- `data/fetch.log` - Log fetch operations
- Console logs vá»›i timestamp

### **Health Check**
```http
GET /
```
Tráº£ vá» tráº¡ng thÃ¡i API vÃ  danh sÃ¡ch endpoints

## ğŸ”„ Data Flow

### **1. Fetch Process**
```
External API â†’ fetcher/index.js â†’ data/full-address.json
```

### **2. Import Process**
```
JSON File â†’ scripts/importUnits.js â†’ MongoDB
```

### **3. API Request Flow**
```
Client Request â†’ Express Router â†’ Controller â†’ MongoDB/JSON â†’ Response
```

### **4. Auto Sync Process**
```
Cron Job (3:00 AM) â†’ fetcher/schedule.js â†’ Update JSON â†’ Sync MongoDB
```

## ğŸš€ Deployment

### **Production Setup**
1. **MongoDB**: CÃ i Ä‘áº·t vÃ  khá»Ÿi Ä‘á»™ng MongoDB
2. **Environment**: Cáº¥u hÃ¬nh `.env` file
3. **Data**: Cháº¡y `npm run fetch` Ä‘á»ƒ láº¥y dá»¯ liá»‡u
4. **Import**: Cháº¡y `npm run import-units` Ä‘á»ƒ import vÃ o DB
5. **Server**: Cháº¡y `npm run start` Ä‘á»ƒ khá»Ÿi Ä‘á»™ng API
6. **Cron**: Cháº¡y `npm run schedule` Ä‘á»ƒ tá»± Ä‘á»™ng cáº­p nháº­t

### **Docker Support** (TÃ¹y chá»n)
```dockerfile
FROM node:18
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

## ğŸ“ˆ Performance

### **Optimizations**
- **Dual Storage**: MongoDB + JSON fallback
- **Indexing**: MongoDB indexes cho tÃ¬m kiáº¿m nhanh
- **Caching**: Middleware cache cho requests
- **Bulk Operations**: Batch insert/update

### **Benchmarks**
- **API Response**: < 100ms cho simple queries
- **Bulk Import**: ~1000 records/second
- **Search**: < 50ms vá»›i MongoDB indexes

## ğŸ”’ Security

### **Input Validation**
- Validate táº¥t cáº£ input parameters
- Sanitize string inputs
- Check data types vÃ  formats

### **Error Handling**
- Global error handler
- Structured error responses
- Logging táº¥t cáº£ errors

## ğŸ“ Changelog

### **v1.0.0** (Current)
- âœ… Core API endpoints
- âœ… MongoDB integration
- âœ… CRUD operations vá»›i history
- âœ… Auto sync vá»›i cron job
- âœ… Comprehensive testing
- âœ… JSON fallback system

## ğŸ¤ Contributing

1. Fork repository
2. Táº¡o feature branch
3. Commit changes
4. Push to branch
5. Táº¡o Pull Request

## ğŸ“„ License

ISC License

## ğŸ‘¥ Support

- **Issues**: Táº¡o issue trÃªn GitHub
- **Documentation**: Xem `docs.txt` cho chi tiáº¿t
- **API Docs**: Cháº¡y server vÃ  truy cáº­p `http://localhost:3000`

---

**ğŸŒ Administrative Boundaries API** - Quáº£n lÃ½ dá»¯ liá»‡u hÃ nh chÃ­nh Viá»‡t Nam má»™t cÃ¡ch hiá»‡u quáº£ vÃ  tin cáº­y.