<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Phòng khám ADHD – Tất cả trong một</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#f5f7fb; --card:#fff; --primary:#0b74d1; --accent:#0fc5c5;
      --danger:#e54; --muted:#6b7280; --border:#e5e7eb;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:"Inter",system-ui,sans-serif; background:var(--bg); color:#1f2937; }
    header { display:flex; justify-content:space-between; align-items:center; padding:18px 24px; background:linear-gradient(90deg,#0b74d1,#0fc5c5); color:#fff; }
    header h1 { margin:0; font-size:20px; }
    .container { max-width:1100px; margin:22px auto; padding:0 16px 48px; }
    .card { background:var(--card); border-radius:14px; padding:18px 20px; box-shadow:0 12px 32px rgba(15,23,42,.08); margin-bottom:18px; }
    h2 { margin:0 0 10px; font-size:20px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; }
    label { display:block; font-size:13px; color:var(--muted); margin-bottom:4px; }
    input,select,textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px; }
    textarea { resize:vertical; min-height:90px; }
    button { border:none; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; font-size:14px; }
    button.primary { background:var(--primary); color:#fff; }
    button.secondary { background:#e5e7eb; color:#111; }
    button.danger { background:var(--danger); color:#fff; }
    nav { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    nav button { background:#e0edff; color:#0b74d1; }
    nav button.active { background:#0b74d1; color:#fff; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th,td { padding:10px 8px; text-align:left; border-bottom:1px solid var(--border); }
    .pill { display:inline-flex; padding:4px 8px; border-radius:12px; background:#eef2ff; font-size:12px; color:#1d4ed8; font-weight:600; }
    .note { border:1px dashed var(--primary); border-radius:12px; padding:12px; background:#f0f8ff; font-size:13px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Hệ thống phòng khám ADHD</h1>
    <div id="topUser" class="pill">Chưa đăng nhập</div>
  </header>
  <div class="container">
    <!-- Auth -->
    <div id="authCard" class="card">
      <div class="grid">
        <div>
          <h2>Đăng nhập</h2>

          <form id="loginForm" style="margin-top:12px">
            <label>Email</label>
            <input id="loginEmail" type="email" required />
            <label>Mật khẩu</label>
            <input id="loginPassword" type="password" required />
            <button class="primary" style="margin-top:12px;width:100%">Đăng nhập</button>
          </form>
        </div>
        <div>
          <h2>Đăng ký</h2>
          <form id="registerForm">
            <label>Họ tên</label>
            <input id="regName" required />
            <label>Email</label>
            <input id="regEmail" type="email" required />
            <label>Mật khẩu</label>
            <input id="regPassword" type="password" required />
            <label>Vai trò</label>
            <select id="regRole">
              <option value="parent">Phụ huynh</option>
              <option value="doctor">Bác sĩ</option>
              <option value="admin">Quản trị</option>
            </select>
            <button class="primary" style="margin-top:12px;width:100%">Tạo tài khoản</button>
          </form>
        </div>
      </div>
    </div>

    <!-- App -->
    <div id="appCard" class="card hidden">
      <nav id="appNav"></nav>
      <section data-view="home" class="view">
        <h2>Trang chủ</h2>
        <div class="grid" id="homeStats"></div>
      </section>

      <section data-view="patients" class="view hidden">
        <div class="grid">
          <div>
            <h2>Quản lý bệnh nhân</h2>
            <form id="patientForm">
              <input type="hidden" id="patientId" />
              <label>Họ tên</label>
              <input id="patientName" required />
              <label>Ngày sinh</label>
              <input id="patientDob" type="date" />
              <label>Giới tính</label>
              <select id="patientGender">
                <option value="">--Chọn--</option>
                <option value="Nam">Nam</option>
                <option value="Nữ">Nữ</option>
              </select>
              <label>Ghi chú</label>
              <textarea id="patientNotes" placeholder="Triệu chứng, lưu ý…"></textarea>
              <div style="display:flex;gap:8px;margin-top:12px">
                <button class="primary" id="patientSaveBtn">Lưu thông tin</button>
                <button type="button" class="secondary" onclick="resetPatientForm()">Xoá trắng</button>
              </div>
            </form>
          </div>
          <div>
            <h2>Danh sách</h2>
            <div id="patientsList"></div>
          </div>
        </div>
      </section>

      <section data-view="doctors" class="view hidden">
        <h2>Danh sách bác sĩ</h2>
        <div id="doctorList"></div>
      </section>

      <section data-view="booking" class="view hidden">
        <div class="grid">
          <div>
            <h2>Đặt lịch khám</h2>
            <form id="bookingForm">
              <label>Bệnh nhân</label>
              <select id="bookingPatient"></select>
              <label>Bác sĩ</label>
              <select id="bookingDoctor"></select>
              <label>Ngày khám</label>
              <input id="bookingDate" type="date" required />
              <label>Giờ khám</label>
              <input id="bookingTime" type="time" required />
              <label>Lý do</label>
              <textarea id="bookingReason" placeholder="Mục đích khám…"></textarea>
              <button class="primary" style="margin-top:12px;width:100%">Đặt lịch</button>
            </form>
          </div>
          <div>
            <h2>Lịch đã đặt</h2>
            <div id="bookingList"></div>
          </div>
        </div>
      </section>

      <section data-view="evaluations" class="view hidden">
        <div class="grid">
          <div>
            <h2>Đánh giá & phác đồ</h2>
            <form id="evaluationForm">
              <label>Bệnh nhân</label>
              <select id="evaluationPatient"></select>
              <label>Ngày đánh giá</label>
              <input id="evaluationDate" type="date" required />
              <label>Điểm đánh giá / thang đo</label>
              <input id="evaluationScore" placeholder="VD: 32 (Vanderbilt)" />
              <label>Phác đồ điều trị</label>
              <textarea id="evaluationPlan"></textarea>
              <button class="primary" style="margin-top:12px;width:100%">Lưu kết quả</button>
            </form>
          </div>
          <div>
            <h2>Lịch sử</h2>
            <div id="evaluationList"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const KEYS = {
      users: 'adhd_users',
      session: 'adhd_session',
      patients: 'adhd_patients',
      doctors: 'adhd_doctors',
      bookings: 'adhd_bookings',
      evaluations: 'adhd_evaluations'
    };
    const state = { user: null };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const load = (k, fb = []) => JSON.parse(localStorage.getItem(k) || JSON.stringify(fb));
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const uid = prefix => prefix + Math.random().toString(36).slice(2, 9);

    function seedDoctors() {
      if (load(KEYS.doctors).length) return;
      save(KEYS.doctors, [
        { id: 'doc1', name: 'BS. Nguyễn Hữu Minh', specialty: 'Tâm lý nhi', phone: '0901 223 456' },
        { id: 'doc2', name: 'BS. Lê Hà Vy', specialty: 'Thần kinh', phone: '0982 445 779' },
        { id: 'doc3', name: 'BS. Phan Đăng Khoa', specialty: 'Nhi tổng quát', phone: '0918 334 220' },
        { id: 'doc4', name: 'BS. Adu', specialty: 'Nhi tổng quát', phone: '0918 924 222' },
        { id: 'doc2', name: 'BS. ADUANHSENG', specialty:'Thần kinh', phone: '0292 233 211'},
        { id: 'doc5', name: 'BS. Trần Thị Bích Ngọc', specialty: 'Tâm lý nhi', phone: '0923 556 889' }


      ]);
    }

    function init() {
      seedDoctors();
      const session = localStorage.getItem(KEYS.session);
      if (session) state.user = JSON.parse(session);
      bindForms();
      renderUI();
    }

    function bindForms() {
      $('#registerForm').addEventListener('submit', e => {
        e.preventDefault();
        const users = load(KEYS.users);
        const email = $('#regEmail').value.trim().toLowerCase();
        if (users.some(u => u.email === email)) {
          alert('Email đã tồn tại.');
          return;
        }
        const newUser = {
          id: uid('usr'),
          name: $('#regName').value.trim(),
          email,
          password: $('#regPassword').value,
          role: $('#regRole').value
        };
        users.push(newUser);
        save(KEYS.users, users);
        alert('Đăng ký thành công, vui lòng đăng nhập.');
        e.target.reset();
      });

      $('#loginForm').addEventListener('submit', e => {
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const pwd = $('#loginPassword').value;
        const user = load(KEYS.users).find(u => u.email === email && u.password === pwd);
        if (!user) {
          alert('Sai thông tin đăng nhập.');
          return;
        }
        state.user = user;
        localStorage.setItem(KEYS.session, JSON.stringify(user));
        renderUI();
      });

      $('#patientForm').addEventListener('submit', e => {
        e.preventDefault();
        const patients = load(KEYS.patients);
        const id = $('#patientId').value || uid('pat');
        const payload = {
          id,
          owner: state.user.id,
          name: $('#patientName').value.trim(),
          dob: $('#patientDob').value,
          gender: $('#patientGender').value,
          notes: $('#patientNotes').value
        };
        const idx = patients.findIndex(p => p.id === id);
        if (idx >= 0) patients[idx] = payload; else patients.push(payload);
        save(KEYS.patients, patients);
        resetPatientForm();
        renderPatients();
        renderBookingHelpers();
        renderEvaluations();
        renderHome();
      });

      $('#bookingForm').addEventListener('submit', e => {
        e.preventDefault();
        const bookings = load(KEYS.bookings);
        bookings.push({
          id: uid('bk'),
          userId: state.user.id,
          patientId: $('#bookingPatient').value,
          doctorId: $('#bookingDoctor').value,
          date: $('#bookingDate').value,
          time: $('#bookingTime').value,
          reason: $('#bookingReason').value
        });
        save(KEYS.bookings, bookings);
        e.target.reset();
        renderBookings();
        renderHome();
      });

      $('#evaluationForm').addEventListener('submit', e => {
        e.preventDefault();
        const evaluations = load(KEYS.evaluations);
        evaluations.push({
          id: uid('ev'),
          userId: state.user.id,
          patientId: $('#evaluationPatient').value,
          date: $('#evaluationDate').value,
          score: $('#evaluationScore').value,
          plan: $('#evaluationPlan').value
        });
        save(KEYS.evaluations, evaluations);
        e.target.reset();
        renderEvaluations();
        renderHome();
      });
    }

    function logout() {
      state.user = null;
      localStorage.removeItem(KEYS.session);
      renderUI();
    }

    function resetPatientForm() {
      $('#patientForm').reset();
      $('#patientId').value = '';
      $('#patientSaveBtn').textContent = 'Lưu thông tin';
    }

    function editPatient(id) {
      const patient = load(KEYS.patients).find(p => p.id === id);
      if (!patient) return;
      $('#patientId').value = patient.id;
      $('#patientName').value = patient.name;
      $('#patientDob').value = patient.dob || '';
      $('#patientGender').value = patient.gender || '';
      $('#patientNotes').value = patient.notes || '';
      $('#patientSaveBtn').textContent = 'Cập nhật';
      switchView('patients');
    }

    function deletePatient(id) {
      if (!confirm('Xóa bệnh nhân khỏi danh sách?')) return;
      let patients = load(KEYS.patients);
      patients = patients.filter(p => p.id !== id);
      save(KEYS.patients, patients);
      renderPatients();
      renderBookingHelpers();
      renderEvaluations();
      renderHome();
    }

    function removeBooking(id) {
      const bookings = load(KEYS.bookings).filter(b => b.id !== id);
      save(KEYS.bookings, bookings);
      renderBookings();
      renderHome();
    }

    function removeEvaluation(id) {
      const evaluations = load(KEYS.evaluations).filter(ev => ev.id !== id);
      save(KEYS.evaluations, evaluations);
      renderEvaluations();
      renderHome();
    }

    function renderUI() {
      $('#topUser').textContent = state.user ? `${state.user.name} (${state.user.role})` : 'Chưa đăng nhập';
      $('#authCard').classList.toggle('hidden', !!state.user);
      $('#appCard').classList.toggle('hidden', !state.user);
      if (!state.user) return;
      buildNav();
      renderHome();
      renderPatients();
      renderDoctorList();
      renderBookingHelpers();
      renderBookings();
      renderEvaluations();
    }

    function buildNav() {
      const map = [
        { view:'home', label:'Trang chủ' },
        { view:'patients', label:'Bệnh nhân' },
        { view:'doctors', label:'Danh sách bác sĩ' },
        { view:'booking', label:'Đặt lịch khám' },
        { view:'evaluations', label:'Đánh giá & phác đồ' },
        { view:'logout', label:'Đăng xuất' }
      ];
      const nav = $('#appNav');
      nav.innerHTML = '';
      map.forEach(item => {
        const btn = document.createElement('button');
        btn.textContent = item.label;
        btn.className = 'secondary';
        btn.addEventListener('click', () => {
          if (item.view === 'logout') logout();
          else switchView(item.view);
        });
        nav.appendChild(btn);
      });
      switchView('home');
    }

    function switchView(view) {
      $$('.view').forEach(sec => sec.classList.toggle('hidden', sec.dataset.view !== view));
      $$('#appNav button').forEach(btn => btn.classList.toggle('active', btn.textContent.includes('Trang') && view === 'home'
        || btn.textContent.includes('Bệnh') && view === 'patients'
        || btn.textContent.includes('bác sĩ') && view === 'doctors'
        || btn.textContent.includes('Đặt lịch') && view === 'booking'
        || btn.textContent.includes('Đánh giá') && view === 'evaluations'));
    }

    function renderHome() {
      if (!state.user) return;
      const patients = ownerData(load(KEYS.patients));
      const bookings = ownerData(load(KEYS.bookings));
      const evaluations = ownerData(load(KEYS.evaluations));
      const stats = [
        { label:'Bệnh nhân', value:patients.length },
        { label:'Lịch khám', value:bookings.length },
        { label:'Đánh giá', value:evaluations.length }
      ];
      $('#homeStats').innerHTML = stats.map(s => `
        <div class="card" style="margin:0">
          <div style="font-size:34px;font-weight:700">${s.value}</div>
          <div class="muted">${s.label}</div>
        </div>`).join('');
    }

    function ownerData(list) {
      if (!state.user) return [];
      if (state.user.role === 'admin') return list;
      return list.filter(item => item.owner === state.user.id || item.userId === state.user.id);
    }

    function renderPatients() {
      if (!state.user) return;
      const patients = ownerData(load(KEYS.patients));
      if (!patients.length) {
        $('#patientsList').innerHTML = '<div class="note">Chưa có bệnh nhân nào.</div>';
        return;
      }
      const rows = patients.map(p => `
        <tr>
          <td>
            <strong>${p.name}</strong><br>
            <span class="pill">${p.gender || 'Chưa rõ'}</span>
          </td>
          <td>${p.dob || '-'}</td>
          <td>${p.notes || '-'}</td>
          <td>
            <button class="secondary" onclick="editPatient('${p.id}')">Sửa</button>
            <button class="danger" onclick="deletePatient('${p.id}')">Xóa</button>
          </td>
        </tr>`).join('');
      $('#patientsList').innerHTML = `<table>
        <thead><tr><th>Bệnh nhân</th><th>Ngày sinh</th><th>Ghi chú</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    }

    function renderDoctorList() {
      const doctors = load(KEYS.doctors);
      const html = doctors.map(d => `
        <div class="card" style="margin:0">
          <h3 style="margin:0">${d.name}</h3>
          <div class="pill" style="margin:6px 0">${d.specialty}</div>
          <div class="muted">Liên hệ: ${d.phone}</div>
        </div>`).join('');
      $('#doctorList').innerHTML = html;
    }

    function renderBookingHelpers() {
      const patients = ownerData(load(KEYS.patients));
      const doctors = load(KEYS.doctors);
      $('#bookingPatient').innerHTML = patients.length
        ? patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('')
        : '<option value="">Chưa có bệnh nhân</option>';
      $('#evaluationPatient').innerHTML = $('#bookingPatient').innerHTML;
      $('#bookingDoctor').innerHTML = doctors.map(d => `<option value="${d.id}">${d.name} – ${d.specialty}</option>`).join('');
    }

    function renderBookings() {
      const bookings = ownerData(load(KEYS.bookings));
      if (!bookings.length) {
        $('#bookingList').innerHTML = '<div class="note">Chưa có lịch nào.</div>';
        return;
      }
      const patients = load(KEYS.patients);
      const doctors = load(KEYS.doctors);
      $('#bookingList').innerHTML = bookings.map(b => {
        const patient = patients.find(p => p.id === b.patientId) || { name:'(đã xóa)' };
        const doctor = doctors.find(d => d.id === b.doctorId) || { name:'(đã xóa)' };
        return `<div class="card" style="margin:0 0 12px">
          <strong>${patient.name}</strong> · ${b.date} ${b.time}<br>
          Bác sĩ: ${doctor.name}<br>
          Lý do: ${b.reason || '-'}
          <div style="margin-top:8px">
            <button class="danger" onclick="removeBooking('${b.id}')">Huỷ lịch</button>
          </div>
        </div>`;
      }).join('');
    }

    function renderEvaluations() {
      const evaluations = ownerData(load(KEYS.evaluations));
      if (!evaluations.length) {
        $('#evaluationList').innerHTML = '<div class="note">Chưa có đánh giá nào.</div>';
        return;
      }
      const patients = load(KEYS.patients);
      $('#evaluationList').innerHTML = evaluations.map(ev => {
        const patient = patients.find(p => p.id === ev.patientId) || { name:'(đã xóa)' };
        return `<div class="card" style="margin:0 0 12px">
          <strong>${patient.name}</strong> · ${ev.date}<br>
          Điểm: ${ev.score || '-'}<br>
          Phác đồ: ${ev.plan || '-'}
          <div style="margin-top:8px">
            <button class="danger" onclick="removeEvaluation('${ev.id}')">Xóa</button>
          </div>
        </div>`;
      }).join('');
    }

    window.editPatient = editPatient;
    window.deletePatient = deletePatient;
    window.removeBooking = removeBooking;
    window.removeEvaluation = removeEvaluation;

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>